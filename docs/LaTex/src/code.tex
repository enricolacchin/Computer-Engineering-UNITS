\usepackage{listings}
\usepackage{xstring}

\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{ltgray}{rgb}{0.5,0.5,0.5}
\definecolor{royalpurple}{rgb}{0.47, 0.32, 0.66}


\newif\ifcolname
\colnamefalse

\newcommand{\keywordcheck}{%
\IfStrEq*{\the\lst@token}{SELECT}{\global\colnametrue}{}%
\IfStrEq*{\the\lst@token}{WHERE}{\global\colnametrue}{}%
\IfStrEq*{\the\lst@token}{FROM}{\global\colnamefalse}{}%
\IfStrEq*{\the\lst@token}{USE}{\global\colnamefalse}{}%
\color{orange}%
}
\newcommand{\setidcolor}{%
\ifcolname\color{royalpurple}\else\color{black}\fi%
}


\lstset{
    basicstyle={\small\ttfamily},
    breakatwhitespace=false,
    breaklines=true,
    captionpos=b,
    commentstyle=\color{dkgreen},
    deletekeywords={...},
    escapeinside={\%*}{*)},
    extendedchars=true,
    frame=single,
    keepspaces=true,
    language=SQL,
    otherkeywords={IF, SHOW, DECLARE, OPEN, FETCH, CLOSE, DATABASE, DATABASES, USE, COMMENT, CHANGE, REFERENCES, RENAME, TO, IS, AUTO\_INCREMENT, EXISTS},
    morekeywords={*,modify,MODIFY,\ldots},
    keywordstyle=\keywordcheck,
    identifierstyle=\setidcolor,
    stringstyle=\color{red},
    numbers=left,
    numbersep=15pt,
    numberstyle=\tiny,
    rulecolor=\color{ltgray},
    showspaces=false,
    showstringspaces=false, 
    showtabs=false,
    stepnumber=1,
    tabsize=2,
    xleftmargin =1em
}